name: Build & Deploy AXI Project Dashboard

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ„å»ºåº”ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false      # è®©ä¸‹é¢ä¸€æ­¥æ˜¾å¼å®‰è£…ï¼Œæ—¥å¿—æ›´æ¸…æ™°

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–..."
          # å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å†²çª
          rm -rf node_modules pnpm-lock.yaml
          # é‡æ–°å®‰è£…ä¾èµ–ï¼Œä½¿ç”¨å¹²å‡€çš„å®‰è£…
          echo "ğŸ“ é‡æ–°å®‰è£…é¡¹ç›®ä¾èµ–..."
          pnpm install --no-frozen-lockfile --shamefully-hoist
          # å®‰è£…å‰ç«¯æœåŠ¡å™¨éœ€è¦çš„ä¾èµ–
          echo "ğŸ”§ å®‰è£…å‰ç«¯æœåŠ¡å™¨ä¾èµ–..."
          pnpm add helmet compression --prod -w
          # éªŒè¯å…³é”®ä¾èµ–
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–..."
          ls -la node_modules/depd/ || echo "âš ï¸ depd æ¨¡å—æœªæ‰¾åˆ°"
          ls -la node_modules/express/ || echo "âš ï¸ express æ¨¡å—æœªæ‰¾åˆ°"
          ls -la node_modules/helmet/ || echo "âš ï¸ helmet æ¨¡å—æœªæ‰¾åˆ°"
          ls -la node_modules/compression/ || echo "âš ï¸ compression æ¨¡å—æœªæ‰¾åˆ°"

      - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "é¡¹ç›®æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo "åç«¯ç›®å½•å†…å®¹:"
          ls -la backend/ || echo "backend ç›®å½•ä¸å­˜åœ¨"
          echo "å‰ç«¯ç›®å½•å†…å®¹:"
          ls -la frontend/ || echo "frontend ç›®å½•ä¸å­˜åœ¨"

      - name: æ„å»ºåç«¯
        working-directory: backend
        run: |
          echo "ğŸ”§ å¼€å§‹æ„å»ºåç«¯..."
          # å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å†²çª
          rm -rf node_modules dist pnpm-lock.yaml
          # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependencies ç”¨äºæ„å»ºï¼‰
          pnpm install --no-frozen-lockfile --shamefully-hoist
          # ç¡®ä¿å…³é”®ä¾èµ–å­˜åœ¨
          echo "ğŸ” éªŒè¯æ„å»ºä¾èµ–..."
          ls node_modules/typescript || echo "âŒ TypeScript ç¼ºå¤±"
          ls node_modules/depd || echo "âŒ depd ç¼ºå¤±"
          ls node_modules/express || echo "âŒ express ç¼ºå¤±"
          # æ„å»ºé¡¹ç›®
          echo "ğŸ”¨ å¼€å§‹TypeScriptç¼–è¯‘..."
          npx tsc
          echo "âœ… åç«¯æ„å»ºå®Œæˆ"
          echo "æ„å»ºäº§ç‰©:"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          ls -la dist/*.js || echo "ç¼–è¯‘çš„JSæ–‡ä»¶ä¸å­˜åœ¨"

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        env:
          REACT_APP_API_URL: https://redamancy.com.cn/project-dashboard/api
          REACT_APP_WS_URL: wss://redamancy.com.cn/project-dashboard/ws
          REACT_APP_ENV: production
        run: |
          echo "ğŸ”§ å¼€å§‹æ„å»ºå‰ç«¯..."
          pnpm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          echo "æ„å»ºäº§ç‰©:"
          ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"

      - name: å‡†å¤‡åç«¯ç”Ÿäº§ä¾èµ–
        working-directory: backend
        run: |
          echo "ğŸ”§ å‡†å¤‡åç«¯ç”Ÿäº§ä¾èµ–..."
          
          # å½»åº•æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å†²çª
          rm -rf node_modules pnpm-lock.yaml
          
          # é‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–ï¼Œä½¿ç”¨å¹²å‡€çš„å®‰è£…
          echo "ğŸ”§ é‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–..."
          pnpm install --prod --no-frozen-lockfile --shamefully-hoist
          
          # éªŒè¯Expressä¾èµ–å®Œæ•´æ€§
          echo "ğŸ” éªŒè¯Expressä¾èµ–å®Œæ•´æ€§..."
          CRITICAL_DEPS="express merge-descriptors depd debug encodeurl utils-merge escape-html finalhandler fresh parseurl body-parser"
          MISSING_CRITICAL=""
          
          for dep in $CRITICAL_DEPS; do
            if [ ! -d "node_modules/$dep" ]; then
              echo "âŒ ç¼ºå¤±ä¾èµ–: $dep"
              MISSING_CRITICAL="$MISSING_CRITICAL $dep"
            else
              echo "âœ… ä¾èµ–å­˜åœ¨: $dep"
            fi
          done
          
          if [ -n "$MISSING_CRITICAL" ]; then
            echo "ğŸ”§ æ‰‹åŠ¨å®‰è£…ç¼ºå¤±çš„å…³é”®ä¾èµ–..."
            pnpm add $MISSING_CRITICAL --prod --shamefully-hoist
          fi
          
          # éªŒè¯å…³é”®Expressä¾èµ–
          echo "ğŸ” éªŒè¯Expressä¾èµ–å®Œæ•´æ€§..."
          CRITICAL_DEPS="express merge-descriptors depd debug encodeurl utils-merge escape-html finalhandler fresh parseurl body-parser"
          MISSING_CRITICAL=""
          
          for dep in $CRITICAL_DEPS; do
            if [ ! -d "node_modules/$dep" ]; then
              MISSING_CRITICAL="$MISSING_CRITICAL $dep"
            fi
          done
          
          if [ -n "$MISSING_CRITICAL" ]; then
            echo "âŒ ä»æœ‰å…³é”®ä¾èµ–ç¼ºå¤±: $MISSING_CRITICAL"
            echo "ğŸ”§ æ‰‹åŠ¨å®‰è£…ç¼ºå¤±çš„å…³é”®ä¾èµ–..."
            pnpm add $MISSING_CRITICAL --prod
          fi
          
          # å®‰è£…å‰ç«¯æœåŠ¡å™¨éœ€è¦çš„ä¾èµ–
          echo "ğŸ”§ å®‰è£…å‰ç«¯æœåŠ¡å™¨ä¾èµ–..."
          pnpm add helmet compression --prod -w
          
          # æœ€ç»ˆéªŒè¯
          echo "âœ… Expressä¾èµ–å®‰è£…å®Œæˆ"
          
          # æœ€ç»ˆéªŒè¯
          echo "ğŸ“‹ æœ€ç»ˆä¾èµ–æ£€æŸ¥..."
          ls node_modules/express || echo "âŒ express ç¼ºå¤±"
          ls node_modules/merge-descriptors || echo "âŒ merge-descriptors ç¼ºå¤±"
          ls node_modules/depd || echo "âŒ depd ç¼ºå¤±"
          ls node_modules/debug || echo "âŒ debug ç¼ºå¤±"
          ls node_modules/encodeurl || echo "âŒ encodeurl ç¼ºå¤±"
          ls node_modules/finalhandler || echo "âŒ finalhandler ç¼ºå¤±"
          ls node_modules/mysql2 || echo "âŒ mysql2 ç¼ºå¤±"
          ls node_modules/module-alias || echo "âŒ module-alias ç¼ºå¤±"
          
          # æŠ¥å‘Šä¾èµ–ç»Ÿè®¡
          TOTAL_DEPS=$(ls node_modules 2>/dev/null | wc -l || echo '0')
          echo "ğŸ“Š æ€»ä¾èµ–åŒ…æ•°é‡: $TOTAL_DEPS"
          
          if [ "$TOTAL_DEPS" -lt 80 ]; then
            echo "âš ï¸ ä¾èµ–åŒ…æ•°é‡åå°‘ ($TOTAL_DEPS < 80)ï¼Œå¯èƒ½å­˜åœ¨ä¾èµ–ç¼ºå¤±"
          else
            echo "âœ… ä¾èµ–åŒ…æ•°é‡æ­£å¸¸ ($TOTAL_DEPS >= 80)"
          fi
          
          # æ£€æŸ¥Expressæ¨¡å—å®Œæ•´æ€§
          echo "ğŸ” éªŒè¯Expressæ¨¡å—å®Œæ•´æ€§..."
          if [ -f "node_modules/express/package.json" ]; then
            echo "âœ… Expressä¸»æ¨¡å—å­˜åœ¨"
          else
            echo "âŒ Expressä¸»æ¨¡å—æŸå"
            exit 1
          fi
          
          # å°† node_modules å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
          mkdir -p ../temp_backend_deps
          cp -r node_modules ../temp_backend_deps/
          echo "âœ… åç«¯ä¾èµ–å‡†å¤‡å®Œæˆ"

      - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ğŸ”§ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          mkdir -p dist
          
                     # å¤åˆ¶åç«¯æ„å»ºäº§ç‰©
           mkdir -p dist/backend
           cp -r backend/dist/* dist/backend/
          cp -r temp_backend_deps/node_modules dist/
          cp backend/package.json dist/
          cp backend/package.json dist/backend/
          cp backend/build.js dist/backend/
          cp backend/tsconfig.json dist/backend/
          cp backend/test-simple.js dist/backend/
          cp backend/index.js dist/backend/
          
          # å¤åˆ¶å…³é”®çš„å¯åŠ¨å’Œæ„å»ºè„šæœ¬
          cp backend/start-server.js dist/backend/
          cp backend/start-simple.js dist/backend/
          cp backend/simple-build.js dist/backend/
          cp backend/quick-start.js dist/backend/
          cp backend/test-start.js dist/backend/
          
          # éªŒè¯å…³é”®æ„å»ºäº§ç‰©
          echo "ğŸ” éªŒè¯åç«¯æ„å»ºäº§ç‰©..."
          ls -la dist/backend/ || echo "âŒ backendæ„å»ºäº§ç‰©ä¸å­˜åœ¨"
          ls -la dist/backend/test-simple.js || echo "âŒ æµ‹è¯•æœåŠ¡å™¨æ–‡ä»¶ä¸å­˜åœ¨"
          
          # éªŒè¯Expressæ ¸å¿ƒä¾èµ–
          echo "ğŸ” éªŒè¯Expressä¾èµ–é“¾..."
          ls -la dist/node_modules/express/ || echo "âŒ expressä¾èµ–ä¸å­˜åœ¨"
          ls -la dist/node_modules/merge-descriptors/ || echo "âŒ merge-descriptorsä¾èµ–ä¸å­˜åœ¨"
          ls -la dist/node_modules/depd/ || echo "âŒ depdä¾èµ–ä¸å­˜åœ¨"
          ls -la dist/node_modules/debug/ || echo "âŒ debugä¾èµ–ä¸å­˜åœ¨"
          ls -la dist/node_modules/finalhandler/ || echo "âŒ finalhandlerä¾èµ–ä¸å­˜åœ¨"
          ls -la dist/node_modules/body-parser/ || echo "âŒ body-parserä¾èµ–ä¸å­˜åœ¨"
          
          # è®¡ç®—ä¾èµ–æ•°é‡
          DEP_COUNT=$(ls dist/node_modules/ | wc -l)
          echo "ğŸ“Š ä¾èµ–åŒ…æ•°é‡: $DEP_COUNT"
          
          if [ "$DEP_COUNT" -lt 50 ]; then
            echo "âš ï¸ ä¾èµ–åŒ…æ•°é‡åå°‘ï¼Œå¯èƒ½å®‰è£…ä¸å®Œæ•´"
          else
            echo "âœ… ä¾èµ–åŒ…æ•°é‡æ­£å¸¸"
          fi
          
          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          cp -r frontend/dist dist/frontend
          
          # å¤åˆ¶å‰ç«¯æœåŠ¡å™¨æ–‡ä»¶
          cp frontend-server.js dist/
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp ecosystem.config.js dist/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆå°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
          echo '#!/bin/bash' > dist/start.sh
          echo 'set -e' >> dist/start.sh
          echo 'echo "ğŸš€ Starting axi-project-dashboard backend..."' >> dist/start.sh
          echo 'cd /srv/apps/axi-project-dashboard' >> dist/start.sh
          echo 'echo "Current directory: $(pwd)"' >> dist/start.sh
          echo 'echo "Files in directory:"' >> dist/start.sh
          echo 'ls -la' >> dist/start.sh
          echo 'which node && echo "Node.js: $(node --version)" || echo "Node.js not found"' >> dist/start.sh
          echo 'which pnpm && echo "pnpm: $(pnpm --version)" || echo "pnpm not found"' >> dist/start.sh
          echo 'which npx && echo "npx available" || echo "npx not found"' >> dist/start.sh
          echo 'if command -v pm2 &> /dev/null; then' >> dist/start.sh
          echo '    echo "PM2 found: $(pm2 --version)"' >> dist/start.sh
          echo '    PM2_CMD="pm2"' >> dist/start.sh
          echo 'elif command -v npx &> /dev/null; then' >> dist/start.sh
          echo '    echo "Using npx pm2"' >> dist/start.sh
          echo '    PM2_CMD="npx pm2"' >> dist/start.sh
          echo 'else' >> dist/start.sh
          echo '    echo "ERROR: PM2 not available"' >> dist/start.sh
          echo '    exit 1' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'if [ ! -f ecosystem.config.js ]; then' >> dist/start.sh
          echo '    echo "ERROR: ecosystem.config.js not found"' >> dist/start.sh
          echo '    exit 1' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'if [ ! -f "backend/start-simple.js" ]; then' >> dist/start.sh
          echo '    echo "ERROR: backend/start-simple.js not found"' >> dist/start.sh
          echo '    exit 1' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'if [ ! -f "frontend-server.js" ]; then' >> dist/start.sh
          echo '    echo "ERROR: frontend-server.js not found"' >> dist/start.sh
          echo '    exit 1' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'echo "ğŸ”§ Fixing dependencies..."' >> dist/start.sh
          echo 'cd backend' >> dist/start.sh
          echo 'pnpm add side-channel --save || echo "side-channel already installed"' >> dist/start.sh
          echo 'cd ..' >> dist/start.sh
          echo 'pnpm install --force || echo "Dependencies installation completed"' >> dist/start.sh
          echo 'echo "ğŸ”¨ Building project..."' >> dist/start.sh
          echo 'cd backend' >> dist/start.sh
          echo 'if [ -f "simple-build.js" ]; then' >> dist/start.sh
          echo '    echo "Using simple build..."' >> dist/start.sh
          echo '    node simple-build.js || { echo "ERROR: Simple build failed, trying full build..."; node build.js || { echo "ERROR: All builds failed"; exit 1; }; }' >> dist/start.sh
          echo 'else' >> dist/start.sh
          echo '    echo "Using full build..."' >> dist/start.sh
          echo '    node build.js || { echo "ERROR: Build failed"; exit 1; }' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'cd ..' >> dist/start.sh
          echo 'echo "Found ecosystem.config.js, starting services..."' >> dist/start.sh
          echo '$PM2_CMD stop dashboard-backend dashboard-frontend 2>/dev/null || true' >> dist/start.sh
          echo '$PM2_CMD delete dashboard-backend dashboard-frontend 2>/dev/null || true' >> dist/start.sh
          echo '$PM2_CMD start ecosystem.config.js --update-env' >> dist/start.sh
          echo 'echo "âœ… PM2å¯åŠ¨å‘½ä»¤æ‰§è¡Œå®Œæˆ"' >> dist/start.sh
          echo 'echo "â³ Waiting for service to start..."' >> dist/start.sh
          echo 'SERVICE_PORT=$(grep "PORT:" ecosystem.config.js | head -1 | sed "s/.*PORT: \\([0-9]*\\).*/\\1/")' >> dist/start.sh
          echo 'if [ -z "$SERVICE_PORT" ]; then' >> dist/start.sh
          echo '    SERVICE_PORT=8090' >> dist/start.sh
          echo 'fi' >> dist/start.sh
          echo 'echo "ğŸ” æ£€æŸ¥ç«¯å£ $SERVICE_PORT..."' >> dist/start.sh
          echo 'for i in {1..30}; do' >> dist/start.sh
          echo '    if netstat -tlnp 2>/dev/null | grep -q ":$SERVICE_PORT"; then' >> dist/start.sh
          echo '        echo "âœ… Service is listening on port $SERVICE_PORT"' >> dist/start.sh
          echo '        break' >> dist/start.sh
          echo '    fi' >> dist/start.sh
          echo '    if [ $i -eq 30 ]; then' >> dist/start.sh
          echo '        echo "âŒ Service failed to start on port $SERVICE_PORT after 60 seconds"' >> dist/start.sh
          echo '        $PM2_CMD logs dashboard-backend --lines 10' >> dist/start.sh
          echo '        exit 1' >> dist/start.sh
          echo '    fi' >> dist/start.sh
          echo '    sleep 2' >> dist/start.sh
          echo 'done' >> dist/start.sh
          echo '$PM2_CMD list' >> dist/start.sh
          echo '$PM2_CMD logs dashboard-backend --lines 5' >> dist/start.sh
          echo 'echo "âœ… Start script completed"' >> dist/start.sh
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼ˆå°†åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
          echo '#!/bin/bash' > dist/deploy.sh
          echo 'echo "ğŸš€ å¼€å§‹éƒ¨ç½² axi-project-dashboard..."' >> dist/deploy.sh
          echo 'TARGET_DIR="/srv/apps/axi-project-dashboard"' >> dist/deploy.sh
          echo 'echo "å½“å‰ç”¨æˆ·: $(whoami)"' >> dist/deploy.sh
          echo 'echo "ç”¨æˆ·ID: $(id)"' >> dist/deploy.sh
          echo 'if [ "$(whoami)" = "root" ]; then' >> dist/deploy.sh
          echo '    echo "ä»¥rootç”¨æˆ·èº«ä»½éƒ¨ç½²..."' >> dist/deploy.sh
          echo '    mkdir -p $TARGET_DIR' >> dist/deploy.sh
          echo '    pm2 stop dashboard-backend || true' >> dist/deploy.sh
          echo '    if [ -d "$TARGET_DIR/backend" ]; then' >> dist/deploy.sh
          echo '        echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."' >> dist/deploy.sh
          echo '        cp -r $TARGET_DIR /srv/backups/axi-project-dashboard-$(date +%Y%m%d_%H%M%S) || true' >> dist/deploy.sh
          echo '    fi' >> dist/deploy.sh
          echo '    echo "ğŸ“‚ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨..."' >> dist/deploy.sh
          echo '    cp -r backend $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp -r node_modules $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp -r frontend $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp package.json $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp ecosystem.config.js $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp frontend-server.js $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp start.sh $TARGET_DIR/' >> dist/deploy.sh
          echo '    chmod -R 755 $TARGET_DIR' >> dist/deploy.sh
          echo '    chmod +x $TARGET_DIR/start.sh' >> dist/deploy.sh
          echo 'else' >> dist/deploy.sh
          echo '    echo "ä»¥érootç”¨æˆ·èº«ä»½éƒ¨ç½²..."' >> dist/deploy.sh
          echo '    sudo mkdir -p $TARGET_DIR' >> dist/deploy.sh
          echo '    sudo chown $(whoami):$(whoami) $TARGET_DIR' >> dist/deploy.sh
          echo '    pm2 stop dashboard-backend || true' >> dist/deploy.sh
          echo '    if [ -d "$TARGET_DIR/backend" ]; then' >> dist/deploy.sh
          echo '        echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."' >> dist/deploy.sh
          echo '        sudo cp -r $TARGET_DIR /srv/backups/axi-project-dashboard-$(date +%Y%m%d_%H%M%S) || true' >> dist/deploy.sh
          echo '    fi' >> dist/deploy.sh
          echo '    echo "ğŸ“‚ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨..."' >> dist/deploy.sh
          echo '    cp -r backend $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp -r node_modules $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp -r frontend $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp package.json $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp ecosystem.config.js $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp frontend-server.js $TARGET_DIR/' >> dist/deploy.sh
          echo '    cp start.sh $TARGET_DIR/' >> dist/deploy.sh
          echo '    sudo chown -R $(whoami):$(whoami) $TARGET_DIR' >> dist/deploy.sh
          echo '    chmod +x $TARGET_DIR/start.sh' >> dist/deploy.sh
          echo 'fi' >> dist/deploy.sh
          echo 'cd $TARGET_DIR' >> dist/deploy.sh
          echo 'echo "ğŸ” éªŒè¯éƒ¨ç½²æ–‡ä»¶ç»“æ„..."' >> dist/deploy.sh
          echo 'ls -la backend/ || echo "âŒ backendç›®å½•ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la backend/index.js || echo "âŒ backend/index.jsä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/depd/ || echo "âŒ depdä¾èµ–ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'if [ ! -f "backend/index.js" ]; then' >> dist/deploy.sh
          echo '    echo "âŒ åç«¯ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨ç½²å¤±è´¥"' >> dist/deploy.sh
          echo '    exit 1' >> dist/deploy.sh
          echo 'fi' >> dist/deploy.sh
          echo 'if [ "$(whoami)" = "root" ]; then' >> dist/deploy.sh
          echo '    mkdir -p /var/log/axi-deploy-dashboard' >> dist/deploy.sh
          echo '    chmod 755 /var/log/axi-deploy-dashboard' >> dist/deploy.sh
          echo 'else' >> dist/deploy.sh
          echo '    sudo mkdir -p /var/log/axi-deploy-dashboard' >> dist/deploy.sh
          echo '    sudo chown $(whoami):$(whoami) /var/log/axi-deploy-dashboard' >> dist/deploy.sh
          echo 'fi' >> dist/deploy.sh
          echo 'echo "ğŸ“‹ éªŒè¯éƒ¨ç½²æ–‡ä»¶..."' >> dist/deploy.sh
          echo 'ls -la backend/index.js || echo "âŒ backend/index.js ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la ecosystem.config.js || echo "âŒ ecosystem.config.js ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la frontend-server.js || echo "âŒ frontend-server.js ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/express/ || echo "âŒ expressæ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/merge-descriptors/ || echo "âŒ merge-descriptorsæ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/depd/ || echo "âŒ depdæ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/debug/ || echo "âŒ debugæ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/finalhandler/ || echo "âŒ finalhandleræ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'ls -la node_modules/body-parser/ || echo "âŒ body-parseræ¨¡å—ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'if [ -f "node_modules/express/package.json" ]; then' >> dist/deploy.sh
          echo '    EXPRESS_VERSION=$(grep '"'"'"version"'"'"' node_modules/express/package.json | cut -d'"'"'"'"'"' -f4)' >> dist/deploy.sh
          echo '    echo "âœ… Expressç‰ˆæœ¬: $EXPRESS_VERSION"' >> dist/deploy.sh
          echo 'else' >> dist/deploy.sh
          echo '    echo "âŒ Expressæ¨¡å—æŸå"' >> dist/deploy.sh
          echo '    exit 1' >> dist/deploy.sh
          echo 'fi' >> dist/deploy.sh
          echo 'grep "script:" ecosystem.config.js || echo "âŒ PM2è„šæœ¬é…ç½®ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'node --version || echo "âŒ Node.jsæœªå®‰è£…"' >> dist/deploy.sh
          echo 'pnpm --version || echo "âŒ pnpmæœªå®‰è£…"' >> dist/deploy.sh
          echo 'pm2 --version || echo "âŒ PM2æœªå®‰è£…"' >> dist/deploy.sh
          echo 'echo "ğŸ›‘ åœæ­¢æ—§è¿›ç¨‹..."' >> dist/deploy.sh
          echo 'pm2 stop dashboard-backend || echo "æ²¡æœ‰æ‰¾åˆ°æ—§è¿›ç¨‹"' >> dist/deploy.sh
          echo 'pm2 delete dashboard-backend || echo "æ²¡æœ‰æ—§è¿›ç¨‹éœ€è¦åˆ é™¤"' >> dist/deploy.sh
          echo 'echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡..."' >> dist/deploy.sh
          echo 'if pm2 start ecosystem.config.js --update-env; then' >> dist/deploy.sh
          echo '    echo "âœ… PM2å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"' >> dist/deploy.sh
          echo 'else' >> dist/deploy.sh
          echo '    echo "âŒ PM2å¯åŠ¨å‘½ä»¤å¤±è´¥ï¼Œé€€å‡ºç : $?"' >> dist/deploy.sh
          echo '    cat ecosystem.config.js || echo "æ— æ³•è¯»å–ecosystem.config.js"' >> dist/deploy.sh
          echo '    pwd' >> dist/deploy.sh
          echo '    ls -la' >> dist/deploy.sh
          echo 'fi' >> dist/deploy.sh
          echo 'echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."' >> dist/deploy.sh
          echo 'sleep 10' >> dist/deploy.sh
          echo 'echo "ğŸ“‹ æ£€æŸ¥PM2æœåŠ¡çŠ¶æ€..."' >> dist/deploy.sh
          echo 'pm2 status' >> dist/deploy.sh
          echo 'echo ""' >> dist/deploy.sh
          echo 'echo "ğŸ“‹ æ£€æŸ¥dashboard-backendè¿›ç¨‹è¯¦æƒ…..."' >> dist/deploy.sh
          echo 'pm2 describe dashboard-backend || echo "âŒ dashboard-backendè¿›ç¨‹ä¸å­˜åœ¨"' >> dist/deploy.sh
          echo 'echo ""' >> dist/deploy.sh
          echo 'echo "ğŸ“‹ è·å–æœ€æ–°æ—¥å¿—..."' >> dist/deploy.sh
          echo 'pm2 logs dashboard-backend --lines 20 --nostream || echo "âŒ æ— æ³•è·å–æ—¥å¿—"' >> dist/deploy.sh
          echo 'echo "ğŸ” æ£€æŸ¥ç«¯å£8090å ç”¨æƒ…å†µ..."' >> dist/deploy.sh
          echo 'netstat -tlnp | grep :8090 || echo "âŒ ç«¯å£8090æœªè¢«å ç”¨"' >> dist/deploy.sh
          echo 'echo "ğŸ” æµ‹è¯•æœ¬åœ°ç«¯å£8090..."' >> dist/deploy.sh
          echo 'for i in {1..3}; do' >> dist/deploy.sh
          echo '    echo "å°è¯• $i/3:"' >> dist/deploy.sh
          echo '    if curl -f http://localhost:8090/health; then' >> dist/deploy.sh
          echo '        echo "âœ… æœ¬åœ°å¥åº·æ£€æŸ¥æˆåŠŸ"' >> dist/deploy.sh
          echo '        break' >> dist/deploy.sh
          echo '    else' >> dist/deploy.sh
          echo '        echo "âŒ å°è¯• $i å¤±è´¥"' >> dist/deploy.sh
          echo '        sleep 2' >> dist/deploy.sh
          echo '    fi' >> dist/deploy.sh
          echo 'done' >> dist/deploy.sh
          echo 'echo "âœ… axi-project-dashboard éƒ¨ç½²å®Œæˆï¼"' >> dist/deploy.sh
          
          chmod +x dist/deploy.sh
          

          
          chmod +x dist/start.sh
          
          echo "âœ… éƒ¨ç½²æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          echo "éƒ¨ç½²åŒ…å†…å®¹:"
          ls -la dist/

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -z "$(ls -A dist)" ]; then
            echo "âŒ dist ç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          echo "æ„å»ºåŒ…å¤§å°:"
          du -sh dist/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-axi-project-dashboard
          path: dist/
          retention-days: 1
          if-no-files-found: error

      - name: éªŒè¯ä¸Šä¼ 
        run: |
          echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
          echo "ä¸Šä¼ é€€å‡ºç : $?"
          echo "æ„å»ºåŒ…å†…å®¹:"
          ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ éƒ¨ç½²è¯´æ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deployment-info:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
          echo "- é¡¹ç›®åç§°: ${{ github.repository }}"
          echo "- æ„å»ºID: ${{ github.run_id }}"
          echo "- åˆ†æ”¯: ${{ github.ref_name }}"
          echo "- æäº¤: ${{ github.sha }}"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          echo "- äº§ç‰©åç§°: dist-axi-project-dashboard"
          echo "- äº§ç‰©å†…å®¹: å‰ç«¯æ„å»ºã€åç«¯æ„å»ºã€ä¾èµ–ã€é…ç½®"
          echo "- ä¿ç•™å¤©æ•°: 1å¤©"
          echo ""
          echo "ğŸš€ éƒ¨ç½²æµç¨‹:"
          echo "- axi-deploy å°†é€šè¿‡ workflow_run äº‹ä»¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²"
          echo "- éƒ¨ç½²å°†åœ¨æ„å»ºå®Œæˆåè‡ªåŠ¨å¼€å§‹"
          echo "- æ— éœ€æ‰‹åŠ¨æ“ä½œ"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "- Webç•Œé¢: https://redamancy.com.cn/project-dashboard/"
          echo "- API: https://redamancy.com.cn/project-dashboard/api/"
          echo "- å¥åº·æ£€æŸ¥: https://redamancy.com.cn/project-dashboard/api/health"
          echo "=========================================="

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è§¦å‘è¿œç¨‹éƒ¨ç½² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger-deploy:
    needs: build
    runs-on: ubuntu-latest

    env:                      # æŠŠéœ€è¦çš„å€¼å…¨éƒ¨æ³¨å…¥ç¯å¢ƒå˜é‡
      RUN_ID: ${{ needs.build.outputs.run_id }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }}

    steps:
      - name: è°ƒè¯•SSHé…ç½®
        run: |
          echo "ğŸ” è°ƒè¯•SSHè¿æ¥é…ç½®..."
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.SERVER_HOST }}"
          echo "æœåŠ¡å™¨ç”¨æˆ·: ${{ secrets.SERVER_USER }}" 
          echo "æœåŠ¡å™¨ç«¯å£: ${{ secrets.SERVER_PORT }}"
          echo "SSHå¯†é’¥é•¿åº¦: $(echo '${{ secrets.SERVER_KEY }}' | wc -c)"
          echo "Deploy Center PAT æ˜¯å¦å­˜åœ¨: $([ -n '${{ secrets.DEPLOY_CENTER_PAT }}' ] && echo 'æ˜¯' || echo 'å¦')"
          
          # è¯¦ç»†çš„SSHå¯†é’¥æ ¼å¼æ£€æŸ¥
          echo "ğŸ”‘ SSHå¯†é’¥æ ¼å¼åˆ†æ:"
          SSH_KEY='${{ secrets.SERVER_KEY }}'
          echo "ç¬¬ä¸€è¡Œ: $(echo "$SSH_KEY" | head -1)"
          echo "æœ€åä¸€è¡Œ: $(echo "$SSH_KEY" | tail -1)"
          
          if echo "$SSH_KEY" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
            echo "âœ… æ£€æµ‹åˆ° OpenSSH æ ¼å¼ç§é’¥"
          elif echo "$SSH_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            echo "âš ï¸  æ£€æµ‹åˆ°ä¼ ç»Ÿ RSA æ ¼å¼ç§é’¥ - å¯èƒ½éœ€è¦è½¬æ¢ä¸º OpenSSH æ ¼å¼"
          elif echo "$SSH_KEY" | grep -q "BEGIN EC PRIVATE KEY"; then
            echo "âœ… æ£€æµ‹åˆ° EC æ ¼å¼ç§é’¥"
          elif echo "$SSH_KEY" | grep -q "BEGIN PRIVATE KEY"; then
            echo "âœ… æ£€æµ‹åˆ° PKCS#8 æ ¼å¼ç§é’¥"
          else
            echo "âŒ æ— æ³•è¯†åˆ«çš„å¯†é’¥æ ¼å¼"
          fi
          
          # å¯†é’¥è¡Œæ•°æ£€æŸ¥
          KEY_LINES=$(echo "$SSH_KEY" | wc -l)
          echo "å¯†é’¥è¡Œæ•°: $KEY_LINES"
          
          if [ "$KEY_LINES" -lt 5 ]; then
            echo "âš ï¸  å¯†é’¥è¡Œæ•°è¿‡å°‘ï¼Œå¯èƒ½ä¸å®Œæ•´"
          fi
          
          # éªŒè¯å…³é”®å‚æ•°
          echo "ğŸ“‹ å‚æ•°éªŒè¯:"
          echo "- SERVER_HOST: $([ -n '${{ secrets.SERVER_HOST }}' ] && echo 'âœ…' || echo 'âŒ')"
          echo "- SERVER_USER: $([ -n '${{ secrets.SERVER_USER }}' ] && echo 'âœ…' || echo 'âŒ')"
          echo "- SERVER_PORT: $([ -n '${{ secrets.SERVER_PORT }}' ] && echo 'âœ…' || echo 'âŒ')"
          echo "- SERVER_KEY: $([ -n '${{ secrets.SERVER_KEY }}' ] && echo 'âœ…' || echo 'âŒ')"
          echo "- DEPLOY_CENTER_PAT: $([ -n '${{ secrets.DEPLOY_CENTER_PAT }}' ] && echo 'âœ…' || echo 'âŒ')"

      - name: è§¦å‘éƒ¨ç½²
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // 1. æ‰“åŒ…æœºå¯†ï¼ˆä¸ºäº†é¿å¼€ workflow_call 10 æ¡ secret é™åˆ¶ï¼‰
            const deploySecrets = Buffer.from(JSON.stringify({
              SERVER_HOST: process.env.SERVER_HOST,
              SERVER_PORT: process.env.SERVER_PORT,
              SERVER_USER: process.env.SERVER_USER,
              SERVER_KEY : process.env.SERVER_KEY,
              DEPLOY_CENTER_PAT: process.env.DEPLOY_CENTER_PAT
            })).toString('base64');

            // 2. Nginx é…ç½®ç”¨æ¨¡æ¿å­—ç¬¦ä¸²å†™æ›´æ˜“è¯»
            // ä½¿ç”¨8090ç«¯å£ï¼ˆæ ¹æ®port-config.ymlé…ç½®ï¼‰
            const nginxConfig = `
              # axi-project-dashboard é…ç½®
              location /project-dashboard {
                  alias /srv/apps/axi-project-dashboard/frontend;
                  try_files $uri $uri/ /project-dashboard/index.html;
                  
                  location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location /project-dashboard/api/ {
                  rewrite ^/project-dashboard/api/(.*) /api/$1 break;
                  proxy_pass http://127.0.0.1:8090;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Prefix /project-dashboard;
              }
              
              location /project-dashboard/ws/ {
                  rewrite ^/project-dashboard/ws/(.*) /socket.io/$1 break;
                  proxy_pass http://127.0.0.1:8091;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /project-dashboard/webhook/github {
                  rewrite ^/project-dashboard/webhook/github(.*) /api/webhooks/github$1 break;
                  proxy_pass http://127.0.0.1:8081;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location = /project-dashboard { return 301 /project-dashboard/; }
            `.trim();

            console.log('ğŸš€  è§¦å‘ axi-deploy/main-deployment.yml â€¦');
            console.log('é¡¹ç›®åç§°:', context.repo.repo);
            console.log('æºä»“åº“:', `${context.repo.owner}/${context.repo.repo}`);
            console.log('è¿è¡ŒID:', process.env.RUN_ID);

            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿artifactå®Œå…¨å¯ç”¨
            console.log('â³ ç­‰å¾…artifactå®Œå…¨å¯ç”¨...');
            await new Promise(resolve => setTimeout(resolve, 5000)); // ç­‰å¾…5ç§’
            
            // å†æ¬¡æ£€æŸ¥ workflow run çŠ¶æ€
            console.log('ğŸ” æ£€æŸ¥ workflow run çŠ¶æ€...');
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.RUN_ID
            });
            
            console.log('ğŸ“Š Workflow run çŠ¶æ€:', run.data.status);
            console.log('ğŸ“Š Workflow run ç»“è®º:', run.data.conclusion);
            
            if (run.data.status !== 'completed') {
              console.log('â³ Workflow run å°šæœªå®Œæˆï¼Œç»§ç»­ç­‰å¾…...');
              await new Promise(resolve => setTimeout(resolve, 5000)); // å†ç­‰å¾…5ç§’
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo:  'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project      : context.repo.repo,
                source_repo  : `${context.repo.owner}/${context.repo.repo}`,
                run_id       : process.env.RUN_ID,
                deploy_type  : 'backend',
                                 start_cmd    : 'bash start.sh',
                service_port : '8090', // ä½¿ç”¨é…ç½®çš„ç«¯å£
                nginx_config : nginxConfig,
                test_url     : 'https://redamancy.com.cn/project-dashboard/api/health',
                deploy_secrets: deploySecrets
              }
            });

            console.log('âœ…  éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘ï¼');
            
            // é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿ - éƒ¨ç½²å¼€å§‹
            console.log('ğŸ“¤ é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿ - éƒ¨ç½²å¼€å§‹...');
            try {
              const startNotificationData = {
                project: context.repo.repo,
                status: 'running',
                duration: 0,
                timestamp: new Date().toISOString(),
                sourceRepo: `${context.repo.owner}/${context.repo.repo}`,
                runId: process.env.RUN_ID,
                deployType: 'backend',
                serverHost: process.env.SERVER_HOST,
                logs: 'éƒ¨ç½²å·²å¼€å§‹ï¼Œæ­£åœ¨æ‰§è¡Œ...'
              };
              
              const response = await fetch('https://redamancy.com.cn/project-dashboard/api/webhooks/deployment', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'User-Agent': 'axi-project-dashboard/1.0'
                },
                body: JSON.stringify(startNotificationData)
              });
              
              if (response.ok) {
                console.log('âœ… éƒ¨ç½²å¼€å§‹é€šçŸ¥å‘é€æˆåŠŸ');
              } else {
                console.log('âš ï¸ éƒ¨ç½²å¼€å§‹é€šçŸ¥å‘é€å¤±è´¥:', response.status);
              }
            } catch (error) {
              console.log('âš ï¸ éƒ¨ç½²å¼€å§‹é€šçŸ¥å‘é€å¤±è´¥:', error.message);
            }