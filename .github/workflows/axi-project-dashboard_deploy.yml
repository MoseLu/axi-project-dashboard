name: Build & Trigger Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ„å»ºåº”ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–..."
          rm -rf node_modules pnpm-lock.yaml
          pnpm install --no-frozen-lockfile --shamefully-hoist
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          ls -la
          ls -la backend/ || echo "backend ç›®å½•ä¸å­˜åœ¨"
          ls -la frontend/ || echo "frontend ç›®å½•ä¸å­˜åœ¨"

      - name: æ„å»ºåç«¯
        working-directory: backend
        run: |
          echo "ğŸ”§ å¼€å§‹æ„å»ºåç«¯..."
          rm -rf node_modules dist pnpm-lock.yaml
          pnpm install --no-frozen-lockfile --shamefully-hoist
          echo "ğŸ” éªŒè¯æ„å»ºä¾èµ–..."
          ls node_modules/typescript || echo "âŒ TypeScript ç¼ºå¤±"
          ls node_modules/express || echo "âŒ express ç¼ºå¤±"
          echo "ğŸ”¨ å¼€å§‹TypeScriptç¼–è¯‘..."
          npx tsc
          echo "âœ… åç«¯æ„å»ºå®Œæˆ"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        env:
          REACT_APP_API_URL: https://redamancy.com.cn/project-dashboard/api
          REACT_APP_WS_URL: wss://redamancy.com.cn/project-dashboard/ws
          REACT_APP_ENV: production
        run: |
          echo "ğŸ”§ å¼€å§‹æ„å»ºå‰ç«¯..."
          pnpm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"

      - name: å‡†å¤‡åç«¯ç”Ÿäº§ä¾èµ–
        working-directory: backend
        run: |
          echo "ğŸ”§ å‡†å¤‡åç«¯ç”Ÿäº§ä¾èµ–..."
          rm -rf node_modules pnpm-lock.yaml
          pnpm install --prod --no-frozen-lockfile --shamefully-hoist
          echo "âœ… åç«¯ç”Ÿäº§ä¾èµ–å‡†å¤‡å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/dist/
            backend/node_modules/
            backend/package.json
            backend/start-simple.sh
            backend/ecosystem.config.js
            frontend/dist/
            config/
            scripts/
          retention-days: 1

      - name: è§¦å‘ axi-deploy éƒ¨ç½²
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸš€ è§¦å‘ axi-deploy éƒ¨ç½²å·¥ä½œæµ...');
            console.log('é¡¹ç›®åç§°:', context.repo.repo);
            console.log('æºä»“åº“:', `${context.repo.owner}/${context.repo.repo}`);
            console.log('è¿è¡ŒID:', process.env.RUN_ID);

            // æ„å»º Nginx é…ç½®
            const nginxConfig = `
              location /project-dashboard {
                alias /srv/apps/axi-project-dashboard/frontend;
                try_files $uri $uri/ /project-dashboard/index.html;
              }
              
              location /project-dashboard/api/ {
                rewrite ^/project-dashboard/api/(.*) /api/$1 break;
                proxy_pass http://127.0.0.1:8090;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Prefix /project-dashboard;
              }
              
              location /project-dashboard/ws/ {
                proxy_pass http://127.0.0.1:8090;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /project-dashboard/webhook/github {
                rewrite ^/project-dashboard/webhook/github(.*) /api/webhooks/github$1 break;
                proxy_pass http://127.0.0.1:8081;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location = /project-dashboard {
                return 301 /project-dashboard/;
              }
            `;

            // æ„å»ºéƒ¨ç½²é…ç½®
            const deployConfig = {
              nginx_config: nginxConfig,
              test_url: 'https://redamancy.com.cn/project-dashboard/health',
              start_cmd: 'bash start-simple.sh --reload',
              service_port: '8090',
              mysql_config: '',
              skip_init: false
            };
            
            // å°†éƒ¨ç½²é…ç½®ç¼–ç ä¸ºbase64
            const deployConfigBase64 = Buffer.from(JSON.stringify(deployConfig)).toString('base64');
            
            // è§¦å‘ axi-deploy çš„éƒ¨ç½²å·¥ä½œæµ
            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo: 'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project: context.repo.repo,
                source_repo: `${context.repo.owner}/${context.repo.repo}`,
                run_id: process.env.RUN_ID,
                deploy_type: 'backend',
                deploy_config: deployConfigBase64
              }
            });

            console.log('âœ… axi-deploy éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘ï¼');
            
            // é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿
            console.log('ğŸ“¤ é€šçŸ¥éƒ¨ç½²ä»ªè¡¨æ¿...');
            try {
              const notificationData = {
                project: context.repo.repo,
                status: 'triggered',
                duration: 0,
                timestamp: new Date().toISOString(),
                sourceRepo: `${context.repo.owner}/${context.repo.repo}`,
                runId: process.env.RUN_ID,
                deployType: 'backend',
                logs: 'æ„å»ºå®Œæˆï¼Œå·²è§¦å‘ axi-deploy éƒ¨ç½²å·¥ä½œæµ'
              };
              
              const response = await fetch('https://redamancy.com.cn/project-dashboard/api/webhooks/deployment', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'User-Agent': 'axi-project-dashboard/1.0'
                },
                body: JSON.stringify(notificationData)
              });
              
              if (response.ok) {
                console.log('âœ… éƒ¨ç½²é€šçŸ¥å‘é€æˆåŠŸ');
              } else {
                console.log('âš ï¸ éƒ¨ç½²é€šçŸ¥å‘é€å¤±è´¥:', response.status);
              }
            } catch (error) {
              console.log('âš ï¸ éƒ¨ç½²é€šçŸ¥å‘é€å¤±è´¥:', error.message);
            }