name: Build & Deploy AXI Project Dashboard

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ────────────────────── 构建应用 ──────────────────────
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false      # 让下面一步显式安装，日志更清晰

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 检查项目结构
        run: |
          echo "🔍 检查项目结构..."
          echo "当前目录: $(pwd)"
          echo "项目根目录内容:"
          ls -la
          echo "后端目录内容:"
          ls -la backend/ || echo "backend 目录不存在"
          echo "前端目录内容:"
          ls -la frontend/ || echo "frontend 目录不存在"

      - name: 构建后端
        working-directory: backend
        run: |
          echo "🔧 开始构建后端..."
          pnpm run build
          echo "✅ 后端构建完成"
          echo "构建产物:"
          ls -la dist/ || echo "dist 目录不存在"

      - name: 构建前端
        working-directory: frontend
        env:
          REACT_APP_API_URL: https://redamancy.com.cn/project-dashboard/api
          REACT_APP_WS_URL: wss://redamancy.com.cn/project-dashboard/ws
          REACT_APP_ENV: production
        run: |
          echo "🔧 开始构建前端..."
          pnpm run build
          echo "✅ 前端构建完成"
          echo "构建产物:"
          ls -la build/ || echo "build 目录不存在"

      - name: 准备后端生产依赖
        working-directory: backend
        run: |
          echo "🔧 准备后端生产依赖..."
          # 清理开发依赖，只安装生产依赖
          pnpm install --prod --frozen-lockfile
          # 将 node_modules 复制到临时目录
          mkdir -p ../temp_backend_deps
          cp -r node_modules ../temp_backend_deps/
          echo "✅ 后端依赖准备完成"

      - name: 准备部署文件
        run: |
          echo "🔧 准备部署文件..."
          mkdir -p dist
          
          # 复制后端构建产物
          cp -r backend/dist dist/backend
          cp -r temp_backend_deps/node_modules dist/
          cp backend/package.json dist/
          
          # 复制前端构建产物
          cp -r frontend/build dist/frontend
          
          # 复制配置文件
          cp ecosystem.config.js dist/
          
          # 创建部署脚本
          cat > dist/deploy.sh << 'EOF'
          #!/bin/bash
          echo "🚀 开始部署 axi-project-dashboard..."
          
          # 设置目标目录
          TARGET_DIR="/srv/apps/project-dashboard"
          
          # 确保目录存在
          sudo mkdir -p $TARGET_DIR
          sudo chown deploy:deploy $TARGET_DIR
          
          # 停止现有服务
          pm2 stop dashboard-backend || true
          
          # 备份现有部署（如果存在）
          if [ -d "$TARGET_DIR/backend" ]; then
            echo "📦 备份现有部署..."
            sudo cp -r $TARGET_DIR /srv/backups/project-dashboard-$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # 部署新版本
          echo "📂 部署文件到服务器..."
          sudo cp -r backend $TARGET_DIR/
          sudo cp -r node_modules $TARGET_DIR/
          sudo cp -r frontend $TARGET_DIR/
          sudo cp package.json $TARGET_DIR/
          sudo cp ecosystem.config.js $TARGET_DIR/
          
          # 设置权限
          sudo chown -R deploy:deploy $TARGET_DIR
          
          # 启动服务
          cd $TARGET_DIR
          pm2 start ecosystem.config.js --update-env
          
          # 创建或更新日志目录
          sudo mkdir -p /var/log/axi-deploy-dashboard
          sudo chown deploy:deploy /var/log/axi-deploy-dashboard
          
          echo "✅ axi-project-dashboard 部署完成！"
          pm2 status
          EOF
          
          chmod +x dist/deploy.sh
          
          echo "✅ 部署文件准备完成"
          echo "部署包内容:"
          ls -la dist/

      - name: 验证构建产物
        run: |
          echo "🔍 验证构建产物..."
          if [ ! -d "dist" ]; then
            echo "❌ dist 目录不存在"
            exit 1
          fi
          
          if [ -z "$(ls -A dist)" ]; then
            echo "❌ dist 目录为空"
            exit 1
          fi
          
          echo "✅ 构建产物验证通过"
          echo "构建包大小:"
          du -sh dist/

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dist-axi-project-dashboard
          path: dist/
          retention-days: 1
          if-no-files-found: error

      - name: 验证上传
        run: |
          echo "🔍 验证上传结果..."
          echo "上传退出码: $?"
          echo "构建包内容:"
          ls -la dist/ || echo "dist 目录不存在"

  # ────────────────────── 部署说明 ──────────────────────
  deployment-info:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: 部署信息
        run: |
          echo "🎉 构建完成！"
          echo "=========================================="
          echo "📋 构建信息:"
          echo "- 项目名称: ${{ github.repository }}"
          echo "- 构建ID: ${{ github.run_id }}"
          echo "- 分支: ${{ github.ref_name }}"
          echo "- 提交: ${{ github.sha }}"
          echo ""
          echo "📦 构建产物:"
          echo "- 产物名称: dist-axi-project-dashboard"
          echo "- 产物内容: 前端构建、后端构建、依赖、配置"
          echo "- 保留天数: 1天"
          echo ""
          echo "🚀 部署流程:"
          echo "- axi-deploy 将通过 workflow_run 事件自动触发部署"
          echo "- 部署将在构建完成后自动开始"
          echo "- 无需手动操作"
          echo ""
          echo "🌐 访问地址:"
          echo "- Web界面: https://redamancy.com.cn/project-dashboard/"
          echo "- API: https://redamancy.com.cn/project-dashboard/api/"
          echo "- 健康检查: https://redamancy.com.cn/project-dashboard/api/health"
          echo "=========================================="

  # ────────────────────── 触发远程部署 ──────────────────────
  trigger-deploy:
    needs: build
    runs-on: ubuntu-latest

    env:                      # 把需要的值全部注入环境变量
      RUN_ID: ${{ needs.build.outputs.run_id }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }}

    steps:
      - name: 触发部署
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // 1. 打包机密（为了避开 workflow_call 10 条 secret 限制）
            const deploySecrets = Buffer.from(JSON.stringify({
              SERVER_HOST: process.env.SERVER_HOST,
              SERVER_PORT: process.env.SERVER_PORT,
              SERVER_USER: process.env.SERVER_USER,
              SERVER_KEY : process.env.SERVER_KEY,
              DEPLOY_CENTER_PAT: process.env.DEPLOY_CENTER_PAT
            })).toString('base64');

            // 2. Nginx 配置用模板字符串写更易读
            const nginxConfig = `
              # axi-project-dashboard 配置
              location /project-dashboard {
                  alias /srv/apps/project-dashboard/frontend;
                  try_files $uri $uri/ /project-dashboard/index.html;
                  
                  location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location /project-dashboard/api/ {
                  rewrite ^/project-dashboard/api/(.*) /api/$1 break;
                  proxy_pass http://127.0.0.1:8090;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Prefix /project-dashboard;
              }
              
              location /project-dashboard/ws/ {
                  rewrite ^/project-dashboard/ws/(.*) /socket.io/$1 break;
                  proxy_pass http://127.0.0.1:8091;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /project-dashboard/webhook/github {
                  rewrite ^/project-dashboard/webhook/github(.*) /api/webhooks/github$1 break;
                  proxy_pass http://127.0.0.1:8090;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location = /project-dashboard { return 301 /project-dashboard/; }
            `.trim();

            console.log('🚀  触发 axi-deploy/main-deployment.yml …');
            console.log('项目名称:', context.repo.repo);
            console.log('源仓库:', `${context.repo.owner}/${context.repo.repo}`);
            console.log('运行ID:', process.env.RUN_ID);

            // 等待一段时间确保artifact完全可用
            console.log('⏳ 等待artifact完全可用...');
            await new Promise(resolve => setTimeout(resolve, 5000)); // 等待5秒
            
            // 再次检查 workflow run 状态
            console.log('🔍 检查 workflow run 状态...');
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.RUN_ID
            });
            
            console.log('📊 Workflow run 状态:', run.data.status);
            console.log('📊 Workflow run 结论:', run.data.conclusion);
            
            if (run.data.status !== 'completed') {
              console.log('⏳ Workflow run 尚未完成，继续等待...');
              await new Promise(resolve => setTimeout(resolve, 5000)); // 再等待5秒
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo:  'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project      : context.repo.repo,
                source_repo  : `${context.repo.owner}/${context.repo.repo}`,
                run_id       : process.env.RUN_ID,
                deploy_type  : 'backend',
                start_cmd    : './deploy.sh',
                nginx_config : nginxConfig,
                test_url     : 'https://redamancy.com.cn/project-dashboard/api/health',
                deploy_secrets: deploySecrets
              }
            });

            console.log('✅  部署工作流已成功触发！');