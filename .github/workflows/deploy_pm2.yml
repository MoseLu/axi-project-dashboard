name: Auto Deploy to PM2 (Production)

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy via SSH & PM2 Reload
    runs-on: ubuntu-latest
    steps:
      - name: è¿æ¥åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || 22 }}
          script: |
            set -e
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½² axi-project-dashboard"
            cd /srv/apps/axi-project-dashboard
            echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch --all --prune
            git reset --hard origin/main
            echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
            if command -v pnpm >/dev/null 2>&1; then
              pnpm install --prod --no-frozen-lockfile --shamefully-hoist
            else
              npm ci --production
            fi
            echo "ğŸ”¨ æ„å»ºåç«¯ TypeScript..."
            if [ -f backend/tsconfig.json ]; then
              cd backend && npx tsc && cd ..
            fi
            echo "ğŸŒ æ„å»ºå‰ç«¯..."
            if [ -f frontend/package.json ]; then
              cd frontend && npm run build && cd ..
            fi
            echo "â™»ï¸ ä½¿ç”¨ PM2 é›¶åœæœºé‡è½½æœåŠ¡..."
            if pm2 describe dashboard-backend >/dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js --update-env
            fi
            echo "âœ… éƒ¨ç½²å®Œæˆ"