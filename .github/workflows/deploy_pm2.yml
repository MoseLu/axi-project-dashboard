name: Auto Deploy to PM2 (Production)

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy via SSH & PM2 Reload
    runs-on: ubuntu-latest
    steps:
      - name: 连接到服务器并执行部署
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || 22 }}
          script: |
            set -e
            echo "🚀 开始自动部署 axi-project-dashboard"
            cd /srv/apps/axi-project-dashboard
            echo "🔄 拉取最新代码..."
            git fetch --all --prune
            git reset --hard origin/main
            echo "📦 安装生产依赖..."
            if command -v pnpm >/dev/null 2>&1; then
              pnpm install --prod --no-frozen-lockfile --shamefully-hoist
            else
              npm ci --production
            fi
            echo "🔨 构建后端 TypeScript..."
            if [ -f backend/tsconfig.json ]; then
              cd backend && npx tsc && cd ..
            fi
            echo "🌐 构建前端..."
            if [ -f frontend/package.json ]; then
              cd frontend && npm run build && cd ..
            fi
            echo "♻️ 使用 PM2 零停机重载服务..."
            if pm2 describe dashboard-backend >/dev/null 2>&1; then
              pm2 reload ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js --update-env
            fi
            echo "✅ 部署完成"