name: Deploy axi-project-dashboard

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: æ„å»ºåç«¯
        working-directory: backend
        run: |
          npm ci
          npm run build
          npm prune --production

      - name: æ„å»ºå‰ç«¯
        working-directory: frontend
        env:
          REACT_APP_API_URL: https://redamancy.com.cn/project-dashboard/api
          REACT_APP_WS_URL: wss://redamancy.com.cn/project-dashboard/ws
          REACT_APP_ENV: production
        run: |
          npm ci
          npm run build

      - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          mkdir -p dist
          
          # å¤åˆ¶åç«¯æ„å»ºäº§ç‰©
          cp -r backend/dist dist/backend
          cp -r backend/node_modules dist/
          cp backend/package.json dist/
          
          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          cp -r frontend/build dist/frontend
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp ecosystem.config.js dist/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > dist/deploy.sh << 'EOF'
          #!/bin/bash
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² axi-project-dashboard..."
          
          # è®¾ç½®ç›®æ ‡ç›®å½•
          TARGET_DIR="/srv/apps/project-dashboard"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          sudo mkdir -p $TARGET_DIR
          sudo chown deploy:deploy $TARGET_DIR
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          pm2 stop dashboard-backend || true
          
          # å¤‡ä»½ç°æœ‰éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "$TARGET_DIR/backend" ]; then
            echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            sudo cp -r $TARGET_DIR /srv/backups/project-dashboard-$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          echo "ğŸ“‚ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          sudo cp -r backend $TARGET_DIR/
          sudo cp -r node_modules $TARGET_DIR/
          sudo cp -r frontend $TARGET_DIR/
          sudo cp package.json $TARGET_DIR/
          sudo cp ecosystem.config.js $TARGET_DIR/
          
          # è®¾ç½®æƒé™
          sudo chown -R deploy:deploy $TARGET_DIR
          
          # å¯åŠ¨æœåŠ¡
          cd $TARGET_DIR
          pm2 start ecosystem.config.js --update-env
          
          # åˆ›å»ºæˆ–æ›´æ–°æ—¥å¿—ç›®å½•
          sudo mkdir -p /var/log/axi-deploy-dashboard
          sudo chown deploy:deploy /var/log/axi-deploy-dashboard
          
          echo "âœ… axi-project-dashboard éƒ¨ç½²å®Œæˆï¼"
          pm2 status
          EOF
          
          chmod +x dist/deploy.sh

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-project-dashboard
          path: dist/
          retention-days: 30

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: è§¦å‘éƒ¨ç½²
        uses: actions/github-script@v7
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_KEY: ${{ secrets.SERVER_KEY }}
          DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }}
          RUN_ID: ${{ github.run_id }}
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // 1. æ‰“åŒ…æœºå¯†ï¼ˆä¸ºäº†é¿å¼€ workflow_call 10 æ¡ secret é™åˆ¶ï¼‰
            const deploySecrets = Buffer.from(JSON.stringify({
              SERVER_HOST: process.env.SERVER_HOST,
              SERVER_PORT: process.env.SERVER_PORT,
              SERVER_USER: process.env.SERVER_USER,
              SERVER_KEY : process.env.SERVER_KEY,
              DEPLOY_CENTER_PAT: process.env.DEPLOY_CENTER_PAT
            })).toString('base64');

            // 2. Nginx é…ç½®
            const nginxConfig = `
              # axi-project-dashboard é…ç½®
              location /project-dashboard {
                  alias /srv/apps/project-dashboard/frontend;
                  try_files $uri $uri/ /project-dashboard/index.html;
                  
                  location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location /project-dashboard/api/ {
                  rewrite ^/project-dashboard/api/(.*) /api/$1 break;
                  proxy_pass http://127.0.0.1:8090;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Prefix /project-dashboard;
              }
              
              location /project-dashboard/ws/ {
                  rewrite ^/project-dashboard/ws/(.*) /socket.io/$1 break;
                  proxy_pass http://127.0.0.1:8091;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /project-dashboard/webhook/github {
                  rewrite ^/project-dashboard/webhook/github(.*) /api/webhooks/github$1 break;
                  proxy_pass http://127.0.0.1:8090;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
            `;

            console.log('ğŸš€ å¼€å§‹è§¦å‘ axi-project-dashboard éƒ¨ç½²...');
            console.log('é¡¹ç›®åç§°:', context.repo.repo);
            console.log('æºä»“åº“:', `${context.repo.owner}/${context.repo.repo}`);
            console.log('è¿è¡ŒID:', process.env.RUN_ID);

            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿artifactå®Œå…¨å¯ç”¨
            console.log('â³ ç­‰å¾…artifactå®Œå…¨å¯ç”¨...');
            await new Promise(resolve => setTimeout(resolve, 5000)); // ç­‰å¾…5ç§’
            
            // å†æ¬¡æ£€æŸ¥ workflow run çŠ¶æ€
            console.log('ğŸ” æ£€æŸ¥ workflow run çŠ¶æ€...');
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.RUN_ID
            });
            
            console.log('ğŸ“Š Workflow run çŠ¶æ€:', run.data.status);
            console.log('ğŸ“Š Workflow run ç»“è®º:', run.data.conclusion);
            
            if (run.data.status !== 'completed') {
              console.log('â³ Workflow run å°šæœªå®Œæˆï¼Œç»§ç»­ç­‰å¾…...');
              await new Promise(resolve => setTimeout(resolve, 5000)); // å†ç­‰å¾…5ç§’
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo:  'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project      : context.repo.repo,
                source_repo  : `${context.repo.owner}/${context.repo.repo}`,
                run_id       : process.env.RUN_ID,
                deploy_type  : 'backend',
                start_cmd    : './deploy.sh',
                nginx_config : nginxConfig,
                test_url     : 'https://redamancy.com.cn/project-dashboard/api/health',
                deploy_secrets: deploySecrets
              }
            });

            console.log('âœ… axi-project-dashboard éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘ï¼');
